<!-- extends表明此页面继承自 base.html 文件 -->
{% extends "sheets/base.html" %}
{% load static %}
{% load tags %}
{% load el_pagination_tags %}

<!-- 写入 base.html 中定义的 title -->
{% block title %}
DSM客户档案管理
{% endblock title %}

<!-- 隐藏分隔条 -->
<div class="ui hidden divider">

</div>


<!-- 写入 base.html 中定义的 content -->
{% block index %}
<div id="pusher" class="pusher" style="padding-top:60px">
    <div class="ui hidden divider"></div>
    <div class="ui container">
        <h2 class="ui blue dividing header">现有档案分析</h2>
        <div class="ui hidden divider"></div>
        <div class="ui pointing secondary menu">
            <a class="item active" data-tab="client_cards"><i class="address card icon"></i>客户一览</a>
            <a class="item" data-tab="client_level"><i class="user md icon"></i>客户分层</a>
            <a class="item" data-tab="management_dsm"><i class="paperclip icon"></i>管理分析-地区经理</a>
            <a class="item" data-tab="management_rsp"><i class="paperclip icon"></i>管理分析-代表</a>
        </div>
        <div class="ui tab segment active" data-tab="client_cards">

            <h3 class="ui header">
                <div class="content">
                    客户一览
                    <div class="sub header">信息卡（按潜力排序）</div>
                </div>
            </h3>
<!--            按-->
<!--            <div class="ui selection dropdown">-->
<!--              <input type="hidden" name="gender">-->
<!--              <i class="dropdown icon"></i>-->
<!--              <div class="default text">Gender</div>-->
<!--              <div class="menu">-->
<!--                <div class="item" data-value="1">Male</div>-->
<!--                <div class="item" data-value="0">Female</div>-->
<!--              </div>-->
<!--            </div>-->
<!--            排序-->
            <div class="ui divider"></div>
            <div class="ui container">
                {% if client_list %}
                <div class="ui four cards">
                    {% paginate 12 client_list %}
                    {% for client in client_list %}
                    <div class="card">
                        <div class="content">
<!--                            {% if client.phone != None %}-->
<!--                            <div class="right floated meta">-->
<!--                                    <i class="phone icon"></i>-->
<!--                                        {{ client.phone }}-->
<!--                            </div>-->
<!--                            {% endif %}-->
                            <div class="header">{{ client.name }}</div>
                        </div>
                        <div class="content">
                            <div class="meta">
                                <div class="ui list">
                                    <div class="item">
                                        <span>{{ client.hospital }}</span>
                                    </div>
                                    <div class="item">
                                        <span>{{ client.dept }}</span>
                                        <span>{{ client.title }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content">
                                <div class="ui list">

                                    <div class="item">
                                        <a class="ui red ribbon label">相关病人</a>
                                        <span>{{ client.monthly_patients|stringformat:".0f" }}</span>
                                    </div>
                                    <div class="item">
                                        <a class="ui blue ribbon label">潜力评级</a>
                                            <div class="ui star rating" data-rating="{{ client.potential_level }}" data-max-rating="3"></div>
                                    </div>
                                </div>

                        </div>
                        <div class="extra">
                            <div class="left floated meta">
                                <i class="marker icon"></i><span>{{ client.province }}</span>
                            </div>
                            <div class="right floated meta">
                                <span>{{ client.dsm }}</span>
                                <span>{{ client.rsp }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="ui hidden divider"></div>
                    {% get_pages %}
                    <div class="ui pagination menu">
                        {% if pages.paginated %}
                            {% show_current_number as current_page_number %}

                            <a class="item" href="{{ pages.first.path }}">&lt;&lt;</a>

                            {% if current_page_number|add:'-4' > 1 %}
                                <a class="item" href="?page={{ current_page_number|add:'-5' }}">&hellip;</a>
                            {% endif %}


                            {% for n in pages|length|times %}
                                {% if n == current_page_number %}
                                    <span class="active item" href="?page={{ n }}">{{ n }}</span>
                                {% elif n > current_page_number|add:'-5' and n < current_page_number|add:'5' %}
                                    <a class="item" href="?page={{ n }}">{{ n }}</a>
                                {% endif %}
                            {% endfor %}


                            {% if pages|length > current_page_number|add:'4' %}
                                <a class="item" href="?page={{ current_page_number|add:'5' }}">&hellip;</a>
                            {% endif %}

                            <a class="item" href="{{ pages.last.path }}">&gt;&gt;</a>
                        {% endif %}
                    </div>
                <div class="ui top right attached label">                    <span>&nbsp;&nbsp;&nbsp;&nbsp;当前显示第
                    {{ pages.current_start_index }}-{{ pages.current_end_index }} of {{ pages.total_count }}条档案
                    </span></div>

                {% endif %}
            </div>
        </div>
        <div class="ui tab segment" data-tab="client_level">
            <h3 class="ui header">
                <div class="content">
                    客户潜力分布
                    <div class="sub header">月相关病人数</div>
                </div>
            </h3>
            <div class="ui divider"></div>
            <div class="ui container">
                <div id="treemap_rsp_hosp_client" style="width:1024px; height:600px;"></div>
            </div>
        </div>
        <div class="ui tab segment" data-tab="management_dsm">
            <h3 class="ui header">
                <div class="content">
                    地区经理
                    <div class="sub header">档案数</div>
                </div>
            </h3>
            <div class="ui divider"></div>
            <div class="ui container">
                <div id="bar_dsm" style="width:1024px; height:600px;"></div>
            </div>
            <h3 class="ui header">
                <div class="content">
                    地区经理
                    <div class="sub header">档案分析</div>
                </div>
            </h3>
            <div class="ui divider"></div>
            <div class="ui container" id='dsm_summary' style="width: 100%; overflow-x: scroll; overflow-y: hidden;">
            </div>
        </div>
        <div class="ui tab segment" data-tab="management_rsp">
            <h3 class="ui header">
                <div class="content">
                    代表
                    <div class="sub header">档案分析</div>
                </div>
            </h3>
            <div class="ui divider"></div>
            <div class="ui container" id='rsp_summary' style="width: 100%; overflow-x: scroll; overflow-y: hidden;">
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

$(document).ready(function() {
    $.ajaxSetup({
        data: {csrfmiddlewaretoken: '{{ csrf_token }}'}
    });

    $(
        function () {
            getData('treemap_rsp_hosp_client', '{% url 'clientfile:ajax_chart' 'treemap_rsp_hosp_client' %}')
            getData('bar_dsm', '{% url 'clientfile:ajax_chart' 'bar_dsm' %}');
            getTable('dsm_summary', 'table_dsm', '{% url 'clientfile:ajax_table' '地区经理' %}');
            getTable('rsp_summary', 'table_rsp', '{% url 'clientfile:ajax_table' '负责代表' %}');
        }
    );

    function getTable(div_id, table_id, ajax_url){

        $.ajax({

            // 请求的url
            url: ajax_url,
            // 请求的type
            type: 'GET',
            data: {table_id: table_id},
            // 发送的数据
            // 回调函数，其中ret是返回的JSON，可以以字典的方式调用
            success:function(ret){     //成功执行
                // 把查询结果输出到网页上
                $('#'+div_id).html(ret);


                $('#'+table_id).DataTable(
                    {
                        order: [[1, "desc"]],
                        pageLength: 25,
                        autoWidth: false,
                        language: {
                            search: "在档案中搜索:",
                            sLengthMenu: "每页显示 _MENU_ 条档案"
                        }
                    });
            },
            error: function () {            //失败
                console.log('失败')
            }
        });
    }
    function getData(chart_id, ajax_url) {

        var chart = echarts.init(document.getElementById(chart_id), 'white', {renderer: 'canvas'});

        chart.showLoading({
            text: '正在加载数据'
        });  //增加提示
        $.ajax({
            type: "GET",
            url: ajax_url,
            dataType: 'json',
            success: function (ret) {
                chart.clear();
                chart.setOption(ret.data);
                chart.hideLoading();
            }
        });
    }
});

</script>
<script>
    $(document).ready(function(){
        $('.pointing.secondary.menu .item').tab();
        $(".rating").rating('disable');
        $('.ui.dropdown').dropdown();
        // $('.endless_page_link').attr('class', 'item');
    });

</script>
{% endblock index %}